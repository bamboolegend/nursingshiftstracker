<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Shift Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4299e1 0%, #667eea 100%);
            min-height: 100vh;
            color: #333;
        }

        /* LOGIN SCREEN STYLES */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4299e1 0%, #667eea 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .login-container h1 {
            color: #2d3748;
            margin-bottom: 20px;
        }

        .login-container p {
            color: #4a5568;
            margin-bottom: 30px;
        }

        .login-btn {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .login-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .login-status.error {
            background: rgba(229, 62, 62, 0.1);
            color: #e53e3e;
        }

        .login-status.success {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
        }

        .login-status.info {
            background: rgba(66, 153, 225, 0.1);
            color: #4299e1;
        }

        /* USER INFO STYLES */
        .user-info {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .logout-btn:hover {
            background: #c53030;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .header p {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .connection-status.connected {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
        }

        .connection-status.disconnected {
            background: rgba(229, 62, 62, 0.1);
            color: #e53e3e;
        }

        .connection-status.loading {
            background: rgba(237, 137, 54, 0.1);
            color: #dd6b20;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            font-size: 0.75rem;
            flex-shrink: 0;
            min-width: 70px;
            border: none;
            padding: 8px 10px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            min-height: 44px;
            touch-action: manipulation;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .current-month {
            font-size: 1rem;
            min-width: auto;
            flex: 1;
            text-align: center;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 700;
        }

        .export-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
        }

        .export-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            min-height: 44px;
            touch-action: manipulation;
            flex-shrink: 0;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .calendar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            max-width: 100%;
            word-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 0;
            gap: 3px;
            margin-top: 20px;
        }

        .calendar-header {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: 700;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .calendar-day {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            min-height: 120px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            min-width: 0;
            overflow: hidden;
        }

        .calendar-day:hover {
            background: #edf2f7;
            border-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.other-month {
            background: #f1f5f9;
            color: #a0aec0;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
            color: #2d3748;
            border-color: #dd6b20;
            font-weight: 600;
        }

        .calendar-day.today .day-number {
            color: #2d3748;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .day-number {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 6px;
            text-align: center;
        }

        .shift-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.7rem;
        }

        .shift-tag {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .shift-tag:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .shift-tag.icu {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .shift-tag.pacu {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }

        .shift-tag.floor {
            background: linear-gradient(135deg, #805ad5, #6b46c1);
        }

        .shift-tag.day {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
            color: #2d3748;
        }

        .shift-tag.night {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }

        .shift-tag.other {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
        }

        .shift-tag.sick {
            background: linear-gradient(135deg, #fc8181, #e53e3e);
        }

        .shift-tag.vacation {
            background: linear-gradient(135deg, #68d391, #38a169);
        }

        .shift-tag.requested-vacation {
            background: linear-gradient(135deg, #81e6d9, #38b2ac);
        }

        .add-shift-btn {
            background: rgba(66, 153, 225, 0.1);
            border: 2px dashed #4299e1;
            color: #4299e1;
            padding: 4px;
            border-radius: 8px;
            font-size: 0.7rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            margin-top: 2px;
            touch-action: manipulation;
        }

        .add-shift-btn:hover {
            background: rgba(66, 153, 225, 0.2);
            transform: scale(1.02);
        }

        .stats {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stats h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1rem;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.9) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            min-height: 40px;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            min-height: auto;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            min-height: 44px;
            touch-action: manipulation;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
        }

        .modal-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .modal-btn.danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Other Hours Fields */
        .other-hours-section {
            display: none;
            background: rgba(153, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #9f7aea;
        }

        .other-hours-section.show {
            display: block;
        }

        .hours-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .hours-info {
            font-size: 0.85rem;
            color: #6b46c1;
            margin-top: 5px;
        }

        /* Pay Calculation Styles */
        .pay-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #f7fafc;
            border-radius: 8px;
            overflow: hidden;
        }

        .pay-table th,
        .pay-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .pay-table th {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .pay-table td {
            background: white;
        }

        .pay-table .currency {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .pay-table .total-row {
            background: #f0fff4 !important;
            font-weight: 700;
            border-top: 2px solid #38a169;
        }

        .pay-table .total-row td {
            background: #f0fff4 !important;
        }

        .pay-summary {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }

        .pay-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .pay-summary-item {
            text-align: center;
        }

        .pay-summary-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .pay-summary-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .premium-tag {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .premium-tag.evening {
            background: rgba(237, 137, 54, 0.1);
            color: #dd6b20;
        }

        .premium-tag.night {
            background: rgba(74, 85, 104, 0.1);
            color: #4a5568;
        }

        .premium-tag.weekend {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
        }

        .premium-tag.overtime {
            background: rgba(229, 62, 62, 0.1);
            color: #e53e3e;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .month-nav {
                order: 1;
                width: 100%;
                justify-content: space-between;
            }

            .export-controls {
                order: 2;
                margin-left: 0;
                justify-content: space-between;
                width: 100%;
                flex-wrap: wrap;
            }

            .calendar {
                padding: 12px;
                overflow-x: auto;
            }

            .calendar-day {
                min-height: 80px;
                padding: 4px;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, minmax(38px, 1fr));
                gap: 1px;
            }

            .day-number {
                font-size: 0.8rem;
                margin-bottom: 3px;
            }

            .shift-tag {
                font-size: 0.5rem;
                padding: 1px 3px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 10px;
            }

            .stat-number {
                font-size: 1rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .hours-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 320px) {
            .container {
                padding: 5px;
            }

            .calendar {
                padding: 8px;
            }

            .calendar-grid {
                grid-template-columns: repeat(7, minmax(35px, 1fr));
                gap: 1px;
                min-width: 260px;
            }

            .calendar-day {
                min-height: 60px;
                padding: 2px;
            }

            .day-number {
                font-size: 0.7rem;
                margin-bottom: 2px;
            }

            .shift-tag {
                font-size: 0.4rem;
                padding: 1px 2px;
                border-radius: 4px;
            }

            .add-shift-btn {
                font-size: 0.5rem;
                padding: 1px;
                border-radius: 4px;
            }

            .shift-info {
                gap: 1px;
            }
        }

        @media (max-width: 280px) {
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                min-width: 100%;
                max-width: 100%;
            }

            .calendar-day {
                min-height: 55px;
                padding: 1px;
            }

            .day-number {
                font-size: 0.65rem;
                margin-bottom: 1px;
            }

            .shift-tag {
                font-size: 0.35rem;
                padding: 0px 2px;
                border-radius: 3px;
            }

            .add-shift-btn {
                font-size: 0.45rem;
                padding: 1px;
            }
        }

        @media (hover: none) {
            .calendar-day:hover,
            .nav-btn:hover,
            .export-btn:hover,
            .modal-btn:hover {
                transform: none;
                box-shadow: initial;
            }
        }

        /* Keep export buttons on one line (mobile) */
        @media (max-width: 768px) {
            .export-controls {
                flex-wrap: nowrap !important;
                width: 100%;
                justify-content: center;
                gap: 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .export-btn {
                flex: 1 1 0 !important;
                min-width: 0;
                white-space: nowrap;
                padding: 6px 8px;
                font-size: 0.72rem;
            }
        }

        @media (max-width: 420px) {
            .export-btn {
                padding: 5px 7px;
                font-size: 0.68rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h1>üè• Nursing Shift Tracker</h1>
            <p>Please sign in to access your shift data</p>
            <button id="loginBtn" class="login-btn">Sign in with Google</button>
            <div id="loginStatus" class="login-status"></div>
        </div>
    </div>

    <!-- App container - initially hidden -->
    <div id="appContainer" class="container" style="display: none;">
        <div class="header">
            <h1>üè• Nursing Shift Tracker</h1>
            <p>Track your nursing assignments and workload</p>
            <div class="connection-status connected" id="connectionStatus">
                <div class="status-dot"></div>
                <span>Connected to database</span>
            </div>
        </div>

        <div class="controls">
            <div class="month-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">‚Üê Previous</button>
                <div class="current-month" id="currentMonth"></div>
                <button class="nav-btn" onclick="changeMonth(1)">Next ‚Üí</button>
            </div>
            <div class="export-controls">
                <button class="export-btn" onclick="openNotesModal()">üìù<br>Notes</button>
                <button class="export-btn" onclick="openPayPeriodModal()">üí∞<br>Calculate Pay</button>
                <button class="export-btn" onclick="openSettingsModal()">‚öôÔ∏è<br>Settings</button>
                <button class="export-btn" onclick="exportToCSV()">üìä<br>Export<br>CSV</button>
                <button class="export-btn" onclick="exportToJSON()">üìã<br>Export<br>JSON</button>
            </div>
        </div>

        <div class="calendar">
            <div class="calendar-grid" id="calendar"></div>
        </div>

        <div class="stats">
            <h3>üìä Annual Statistics<br>(Jan 1 - Dec 31, <span id="currentYear"></span>)</h3>
            <div class="stats-grid" id="statsGrid"></div>
        </div>
    </div>

    <!-- Add Shift Modal -->
    <div class="modal" id="shiftModal">
        <div class="modal-content">
            <h3><span id="modalTitle">Add Shift</span> for <span id="selectedDate"></span></h3>

            <div class="form-group">
                <label for="shiftType">Shift Type</label>
                <select id="shiftType">
                    <option value="">Select Shift Type</option>
                    <option value="D">D - Day</option>
                    <option value="N">N - Night</option>
                    <option value="O">O - Other</option>
                    <option value="S">S - Sick Call</option>
                    <option value="V">V - Vacation</option>
                    <option value="RV">RV - Requested Vacation</option>
                </select>
            </div>

            <!-- Other Hours Section -->
            <div id="otherHoursSection" class="other-hours-section">
                <h4 style="margin-bottom: 10px; color: #6b46c1;">‚è∞ Custom Hours for "Other" Shift</h4>
                <div class="hours-info">
                    Enter optional hours for pay calculation and vacation tracking. Leave blank to use defaults.
                </div>
                <div class="hours-row">
                    <div class="form-group">
                        <label for="shiftHours">Shift Hours (optional)</label>
                        <input type="number" id="shiftHours" step="0.25" min="0" placeholder="e.g., 8.0">
                        <div class="hours-info">Hours to be paid at your base rate</div>
                    </div>
                    <div class="form-group">
                        <label for="vacationHours">Vacation Hours (optional)</label>
                        <input type="number" id="vacationHours" step="0.25" min="0" placeholder="e.g., 4.0">
                        <div class="hours-info">Hours deducted from vacation bank</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="unit">Unit (required for Day/Night; optional otherwise)</label>
                <select id="unit" required>
                    <option value="">Select Unit</option>
                    <option value="MSICU">MSICU</option>
                    <option value="CVICU">CVICU</option>
                    <option value="CCU">CCU</option>
                    <option value="MSNICU">MSNICU</option>
                    <option value="TGPACU">TGPACU</option>
                    <option value="TWPACU">TWPACU</option>
                    <option value="Floor">Floor</option>
                </select>
            </div>

            <div class="form-group">
                <label for="assignment">Assignment Type (Optional)</label>
                <select id="assignment">
                    <option value="">Select Assignment</option>
                    <option value="Single">Single Patient</option>
                    <option value="Double">Double Assignment</option>
                </select>
            </div>

            <div class="form-group">
                <label for="isolation">Isolation (Optional)</label>
                <select id="isolation">
                    <option value="">Select Isolation</option>
                    <option value="None">No Isolation</option>
                    <option value="1">1 Isolation</option>
                    <option value="2">2 Isolations</option>
                </select>
            </div>

            <div class="form-group">
                <label>Special Treatments</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="sled" value="SLED">
                        <label for="sled">SLED</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="paline" value="PA Line">
                        <label for="paline">PA Line</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="admission" value="Admission">
                        <label for="admission">Admission</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ecmo" value="ECMO">
                        <label for="ecmo">ECMO</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="comments">Comments</label>
                <textarea id="comments" rows="3" placeholder="Any additional notes about this shift..."></textarea>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                <button id="primaryActionBtn" class="modal-btn primary">Add Shift</button>
            </div>
        </div>
    </div>

    <!-- View Shift Modal -->
    <div class="modal" id="viewShiftModal">
        <div class="modal-content">
            <h3>üìÖ Shift Details - <span id="viewShiftDate"></span></h3>
            <div id="shiftDetails"></div>
            <div class="modal-buttons">
                <button class="modal-btn danger" onclick="deleteShift()" id="deleteBtn">Delete Shift</button>
                <button class="modal-btn secondary" onclick="closeViewModal()">Close</button>
                <button class="modal-btn primary" onclick="editShift()" id="editBtn">Edit Shift</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>‚öôÔ∏è Pay Settings</h3>
            <div class="form-group">
                <label for="baseRate">Base Hourly Rate ($)</label>
                <input type="number" id="baseRate" step="0.01" placeholder="e.g., 35.50">
            </div>
            <div class="form-group">
                <label for="eveningPremium">Evening Premium ($/hr)</label>
                <input type="number" id="eveningPremium" step="0.01" placeholder="e.g., 2.50">
            </div>
            <div class="form-group">
                <label for="nightPremium">Night Premium ($/hr)</label>
                <input type="number" id="nightPremium" step="0.01" placeholder="e.g., 4.00">
            </div>
            <div class="form-group">
                <label for="weekendPremium">Weekend Premium ($/hr)</label>
                <input type="number" id="weekendPremium" step="0.01" placeholder="e.g., 3.00">
            </div>
            <div class="form-group">
                <label for="manualOvertimeHours">Overtime Hours (manual entry)</label>
                <input type="number" id="manualOvertimeHours" step="0.25" placeholder="e.g., 10">
            </div>
            <div class="form-group">
                <label for="overtimeMultiplier">Overtime Multiplier</label>
                <input type="number" id="overtimeMultiplier" step="0.1" placeholder="e.g., 1.5" value="1.5">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeSettingsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Pay Period Modal -->
    <div class="modal" id="payPeriodModal">
        <div class="modal-content">
            <h3>üí∞ Select Pay Period</h3>
            <div class="form-group">
                <label for="payPeriodStart">Pay Period Start Date</label>
                <input type="date" id="payPeriodStart" required>
            </div>
            <div class="form-group">
                <label for="payPeriodEnd">Pay Period End Date</label>
                <input type="date" id="payPeriodEnd" required>
            </div>
            <div class="form-group">
                <label>Quick Select Bi-Weekly Periods:</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                    <button type="button" class="modal-btn secondary" onclick="setCurrentBiWeekly()">Current Period</button>
                    <button type="button" class="modal-btn secondary" onclick="setPreviousBiWeekly()">Previous Period</button>
                    <button type="button" class="modal-btn secondary" onclick="setNextBiWeekly()">Next Period</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closePayPeriodModal()">Cancel</button>
                <button class="modal-btn primary" onclick="calculatePay()">Calculate Pay</button>
            </div>
        </div>
    </div>

    <!-- Pay Calculation Results Modal -->
    <div class="modal" id="payResultsModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <h3>üí∞ Pay Calculation - <span id="payResultsPeriod"></span></h3>
            <div id="payResultsContent"></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="exportPayCSV()">üìÑ Export Pay CSV</button>
                <button class="modal-btn secondary" onclick="closePayResultsModal()">Close</button>
                <button class="modal-btn primary" onclick="openPayPeriodModal()">Calculate Another Period</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal" id="notesModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <h3>üìù Personal Notes</h3>
            <div class="form-group">
                <label>Current Rate & Differentials (notes for this year)</label>
                <textarea id="payNotes" rows="3" placeholder="e.g. Base $35.50, Evening $2.50, Night $4.00, Weekend $3.00"></textarea>
            </div>
            <div class="form-group">
                <label>OT / Mentor / Other (specify) Records<br>*Worked holidays need to be manually recorded*</label>
                <table class="pay-table" id="otMentorTable">
                    <thead>
                        <tr><th>Date</th><th>Type</th><th>Hours</th><th></th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="modal-btn secondary" onclick="addOtMentorEntry()">+ Add Entry</button>
            </div>
            <div class="form-group">
                <label for="vacationBank">Vacation Bank (hours)</label>
                <input type="number" id="vacationBank" step="0.25" placeholder="e.g. 120">
                <div style="margin-top:6px;">
                    <strong>Requested Vacations this year:</strong>
                    <span id="rvCount">0</span> (√ó 11.25h = <span id="rvHours">0.00</span> h)
                </div>
                <div style="margin-top:6px;">
                    <strong>Regular Vacations this year:</strong>
                    <span id="regularVacationCount">0</span> (√ó 7.5h = <span id="regularVacationHours">0.00</span> h)
                </div>
                <div style="margin-top:6px;">
                    <strong>Custom vacation hours used (from Other shifts):</strong> <span id="customVacationHours">0.00</span> h
                </div>
                <div style="margin-top:6px;">
                    <strong>Total vacation used:</strong> <span id="totalVacationUsed">0.00</span> h
                </div>
                <div style="margin-top:6px;">
                    <strong>Remaining bank:</strong> <span id="vacationRemaining">0.00</span> h
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeNotesModal()">Close</button>
                <button class="modal-btn primary" onclick="saveNotes()">Save Notes</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, set, get, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        // CHANGE THIS TO YOUR EMAIL
        const APPROVED_EMAILS = [
            'yvonzh@gmail.com', // Replace with your email
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyB0Bg6ppc4UkoNQjWckpMkjqrle4ieuQlU",
            authDomain: "nursing-shift-tracker.firebaseapp.com",
            databaseURL: "https://nursing-shift-tracker-default-rtdb.firebaseio.com",
            projectId: "nursing-shift-tracker",
            storageBucket: "nursing-shift-tracker.firebasestorage.app",
            messagingSenderId: "911404850414",
            appId: "1:911404850414:web:ebe494fa1968ea0e4667ff",
            measurementId: "G-QMM1YG26K5"
        };

        // Global variables
        let app, database, auth;
        let currentUser = null;
        let isFirebaseInitialized = false;
        let currentDate = new Date();
        let selectedDay = null;
        let selectedDateKey = null;
        let shiftData = {};
        let currentShiftId = null;
        let isEditing = false;
        let paySettings = {};
        let notesData = {
            payNotes: "",
            otMentor: [],
            vacationBank: 0
        };
        let currentPayPeriod = { start: null, end: null };
        
        // Expose globals for debugging/access
        window.currentDate = currentDate;
        window.shiftData = shiftData;

        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        database = getDatabase(app);
        auth = getAuth(app);

        // Set up Google auth provider
        const provider = new GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');

        // Login function
        async function signInWithGoogle() {
            try {
                setLoginStatus('Signing in...', 'info');
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                if (!APPROVED_EMAILS.includes(user.email)) {
                    setLoginStatus('Access denied. Your email is not authorized.', 'error');
                    await signOut(auth);
                    return;
                }

                setLoginStatus('Sign in successful!', 'success');
                currentUser = user;
                
            } catch (error) {
                console.error('Sign in error:', error);
                setLoginStatus('Sign in failed: ' + error.message, 'error');
            }
        }

        // Logout function
        window.logout = async function() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await signOut(auth);
                    currentUser = null;
                    showLoginScreen();
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            }
        };

        // Set login status message
        function setLoginStatus(message, type) {
            const statusEl = document.getElementById('loginStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `login-status ${type}`;
            }
        }

        // Show/hide screens
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showAppScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
        }

        // Authentication state observer
        onAuthStateChanged(auth, (user) => {
            if (user && APPROVED_EMAILS.includes(user.email)) {
                currentUser = user;
                showAppScreen();
                initializeSecureApp(); // Initialize the app after authentication
                
                // Add user info to header
                const header = document.querySelector('.header');
                if (header && !header.querySelector('.user-info')) {
                    const userInfo = document.createElement('div');
                    userInfo.className = 'user-info';
                    userInfo.innerHTML = `
                        <span>Welcome, ${user.displayName || user.email}</span>
                        <button onclick="logout()" class="logout-btn">Logout</button>
                    `;
                    header.appendChild(userInfo);
                }
            } else {
                currentUser = null;
                showLoginScreen();
            }
        });

        // Initialize app after authentication
        async function initializeSecureApp() {
            try {
                updateConnectionStatus('connected', 'Connected to database');
                isFirebaseInitialized = true;
                attachSettingsNotesRealtime();
                setupRealtimeListener();
                renderCalendar();
                updateStats();
                try { updateRVAndBankFigures(); } catch(e){}
                initializePaySettings();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus('disconnected', 'Connection failed: ' + error.message);
            }
        }

        function attachSettingsNotesRealtime() {
            if (!currentUser) return;

            try {
                // SETTINGS
                const settingsRef = getSecureRef('settings');
                onValue(settingsRef, (snap) => {
                    const cloud = snap.val();
                    if (!cloud) return;
                    // Cache for offline + reflect UI if visible
                    window.localStorage.setItem('nursing-pay-settings', JSON.stringify(cloud));
                    paySettings = cloud;
                    ['baseRate','eveningPremium','nightPremium','weekendPremium','manualOvertimeHours','overtimeMultiplier']
                        .forEach(id => { const el = document.getElementById(id); if (el) el.value = (cloud[id] ?? ''); });
                });

                // NOTES
                const notesRef = getSecureRef('notes');
                onValue(notesRef, (snap) => {
                    const cloud = snap.val();
                    if (!cloud) return;
                    notesData = { payNotes: "", otMentor: [], vacationBank: 0, ...cloud };
                    window.localStorage.setItem('nursing-notes', JSON.stringify(notesData));
                    const payNotesEl = document.getElementById('payNotes');
                    const bankEl = document.getElementById('vacationBank');
                    if (payNotesEl) payNotesEl.value = notesData.payNotes || "";
                    if (bankEl) bankEl.value = notesData.vacationBank || 0;
                    renderOtMentorTable();
                    try { updateRVAndBankFigures(); } catch(e){}
                });

            } catch (e) {
                console.error('Realtime attach failed:', e);
            }
        }

        // Secure database operations helper
        function getSecureRef(path) {
            if (!currentUser) throw new Error('User not authenticated');
            return ref(database, `users/${currentUser.uid}/${path}`);
        }

        // Helper functions
        window.isWorkShift = function(st) { return st === 'D' || st === 'N'; };

        window.applyShiftTypeConstraints = function() {
            const sEl = document.getElementById('shiftType');
            const s = sEl ? sEl.value : '';
            const requires = window.isWorkShift(s);
            const isNonWork = (s === 'V' || s === 'RV' || s === 'S');
            const isOther = (s === 'O');
            const unitEl = document.getElementById('unit');
            const unitLabel = unitEl && unitEl.previousElementSibling && unitEl.previousElementSibling.tagName.toLowerCase()==='label' ? unitEl.previousElementSibling : null;

            // Show/hide Other Hours section
            const otherHoursSection = document.getElementById('otherHoursSection');
            if (otherHoursSection) {
                if (isOther) {
                    otherHoursSection.classList.add('show');
                } else {
                    otherHoursSection.classList.remove('show');
                    // Clear the values when hiding
                    const shiftHours = document.getElementById('shiftHours');
                    const vacationHours = document.getElementById('vacationHours');
                    if (shiftHours) shiftHours.value = '';
                    if (vacationHours) vacationHours.value = '';
                }
            }

            if (unitEl) {
                unitEl.required = requires;
                unitEl.disabled = isNonWork;
            }
            if (unitLabel) {
                unitLabel.textContent = requires
                    ? 'Unit (required for Day/Night; optional otherwise)'
                    : (isNonWork ? 'Unit (not required for this shift type)' : 'Unit (optional for Other)');
            }

            const assignmentEl = document.getElementById('assignment');
            const isolationEl = document.getElementById('isolation');
            const checkboxes = document.querySelectorAll('#shiftModal input[type="checkbox"]');
            const disable = isNonWork;
            if (assignmentEl) assignmentEl.disabled = disable;
            if (isolationEl)  isolationEl.disabled  = disable;
            checkboxes.forEach(cb => cb.disabled = disable);
        };

        // SECURE ADD SHIFT
        window.addShift = async function() {
            if (!currentUser) {
                alert('Please sign in to add shifts');
                return;
            }

            const unit = document.getElementById('unit').value;
            const stVal = document.getElementById('shiftType').value || '';
            const requiresUnit = window.isWorkShift(stVal);
            const isNonWork = (stVal === 'V' || stVal === 'RV' || stVal === 'S');
            if (requiresUnit && !unit) { 
                alert('Please select a unit for Day/Night shifts'); 
                return; 
            }

            const treatments = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            // Get custom hours for "Other" shift type
            const shiftHours = stVal === 'O' ? (parseFloat(document.getElementById('shiftHours').value) || null) : null;
            const vacationHours = stVal === 'O' ? (parseFloat(document.getElementById('vacationHours').value) || null) : null;

            const shiftRecord = {
                id: Date.now().toString(),
                unit,
                shiftType: document.getElementById('shiftType').value || 'Not specified',
                assignment: document.getElementById('assignment').value || 'Not specified',
                isolation: document.getElementById('isolation').value || 'Not specified',
                treatments,
                comments: document.getElementById('comments').value || '',
                date: selectedDateKey,
                createdAt: new Date().toISOString(),
                // Add custom hours for "Other" shifts
                shiftHours: shiftHours,
                vacationHours: vacationHours
            };

            try {
                const shiftRef = getSecureRef(`nursing-shifts/${selectedDateKey}`);
                await set(shiftRef, shiftRecord);
                closeModal();
                try { updateRVAndBankFigures(); } catch(e){}
            } catch (error) {
                console.error('Error adding shift:', error);
                alert('Failed to add shift: ' + error.message);
            }
        };

        // SECURE UPDATE SHIFT  
        window.updateShift = async function() {
            if (!currentUser) {
                alert('Please sign in to update shifts');
                return;
            }

            const unit = document.getElementById('unit').value;
            const stVal = document.getElementById('shiftType').value || '';
            const requiresUnit = window.isWorkShift(stVal);
            const isNonWork = (stVal === 'V' || stVal === 'RV' || stVal === 'S');
            if (requiresUnit && !unit) { 
                alert('Please select a unit for Day/Night shifts'); 
                return; 
            }

            const treatments = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            // Get custom hours for "Other" shift type
            const shiftHours = stVal === 'O' ? (parseFloat(document.getElementById('shiftHours').value) || null) : null;
            const vacationHours = stVal === 'O' ? (parseFloat(document.getElementById('vacationHours').value) || null) : null;

            const shiftRecord = {
                id: currentShiftId,
                unit,
                shiftType: document.getElementById('shiftType').value || 'Not specified',
                assignment: document.getElementById('assignment').value || 'Not specified',
                isolation: document.getElementById('isolation').value || 'Not specified',
                treatments,
                comments: document.getElementById('comments').value || '',
                date: selectedDateKey,
                updatedAt: new Date().toISOString(),
                // Add custom hours for "Other" shifts
                shiftHours: shiftHours,
                vacationHours: vacationHours
            };

            try {
                const shiftRef = getSecureRef(`nursing-shifts/${selectedDateKey}`);
                await set(shiftRef, shiftRecord);
                closeModal();
            } catch (error) {
                console.error('Error updating shift:', error);
                alert('Failed to update shift: ' + error.message);
            }
        };

        // SECURE DELETE SHIFT
        window.deleteShift = async function() {
            if (!currentUser) {
                alert('Please sign in to delete shifts');
                return;
            }

            if (!confirm('Are you sure you want to delete this shift?')) return;
            
            try {
                const shiftRef = getSecureRef(`nursing-shifts/${selectedDateKey}`);
                await remove(shiftRef);
                closeViewModal();
                try { updateRVAndBankFigures(); } catch(e){}
            } catch (error) {
                console.error('Error deleting shift:', error);
                alert('Failed to delete shift: ' + error.message);
            }
        };

        // SECURE REALTIME LISTENER
        function setupRealtimeListener() {
            if (!currentUser) return;
            
            const shiftsRef = getSecureRef('nursing-shifts');
            onValue(shiftsRef, (snapshot) => {
                const data = snapshot.val();
                shiftData = data || {};
                window.shiftData = shiftData;
                renderCalendar();
                updateStats();
            }, (error) => {
                console.error('Database read error:', error);
                updateConnectionStatus('disconnected', 'Error reading from database: ' + error.message);
            });
        }

        // Utility functions
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `connection-status ${status}`;
                const span = statusElement.querySelector('span');
                if (span) span.textContent = message;
            }
        }

        window.changeMonth = function(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            window.currentDate = currentDate;
            renderCalendar();
        };

        function getDateKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getDateKeyUnpadded(date) {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1);
            const d = date.getDate();
            return `${y}-${m}-${d}`;
        }

        function parseLocalDateKey(dateKey) {
            if (dateKey instanceof Date) return new Date(dateKey.getFullYear(), dateKey.getMonth(), dateKey.getDate());
            const parts = String(dateKey).split('-').map(Number);
            if (parts.length >= 3 && !Number.isNaN(parts[0])) {
                const y = parts[0], m = parts[1], d = parts[2];
                return new Date(y, m - 1, d);
            }
            return new Date(dateKey);
        }

        function parseLocalInputDate(inputStr) {
            const [y, m, d] = String(inputStr).split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function formatDateForInputLocal(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getShiftTypeDisplay(shiftType) {
            const shiftTypeMap = {
                'D': 'Day',
                'N': 'Night',
                'O': 'Other',
                'S': 'Sick',
                'V': 'Vacation',
                'RV': 'RV'
            };
            return shiftTypeMap[shiftType] || shiftType;
        }

        function getShiftTypeClass(shiftType) {
            const classMap = {
                'D': 'day',
                'N': 'night',
                'O': 'other',
                'S': 'sick',
                'V': 'vacation',
                'RV': 'requested-vacation'
            };
            return classMap[shiftType] || '';
        }

        // Calculate actual hours for a shift (including custom hours for "Other")
        function getShiftHours(shift) {
            if (shift.shiftType === 'O') {
                // For "Other" shifts, total paid hours = shift hours + vacation hours
                const shiftHours = (typeof shift.shiftHours === 'number') ? shift.shiftHours : 0;
                const vacationHours = (typeof shift.vacationHours === 'number') ? shift.vacationHours : 0;
                return shiftHours + vacationHours;
            } else if (shift.shiftType === 'V') {
                return 7.5;
            } else if (shift.shiftType === 'RV') {
                return 11.25;
            } else {
                return 11.25; // Default for D, N, S
            }
        }

        // Calculate vacation hours used for a shift
        function getVacationHoursUsed(shift) {
            if (shift.shiftType === 'O' && typeof shift.vacationHours === 'number') {
                return shift.vacationHours; // Custom vacation hours for Other
            } else if (shift.shiftType === 'V') {
                return 7.5;
            } else if (shift.shiftType === 'RV') {
                return 11.25;
            } else {
                return 0; // No vacation hours used for regular shifts
            }
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthElement = document.getElementById('currentMonth');
            
            monthElement.textContent = currentDate.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            calendar.innerHTML = '';

            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach((day) => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const today = new Date();

            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                calendar.appendChild(emptyDay);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);

                const paddedKey   = getDateKey(date);
                const unpaddedKey = getDateKeyUnpadded(date);
                const dayData     = shiftData[paddedKey] || shiftData[unpaddedKey];
                const resolvedKey = shiftData[paddedKey] ? paddedKey
                                  : (shiftData[unpaddedKey] ? unpaddedKey : null);
                dayElement.onclick = () => viewShift(date, dayData, resolvedKey);
                
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                const shiftInfo = document.createElement('div');
                shiftInfo.className = 'shift-info';

                if (dayData) {
                    if (dayData.shiftType) {
                        const shiftTypeTag = document.createElement('div');
                        shiftTypeTag.className = `shift-tag ${getShiftTypeClass(dayData.shiftType)}`;
                        let displayText = getShiftTypeDisplay(dayData.shiftType);
                        
                        // Add custom hours display for "Other" shifts
                        if (dayData.shiftType === 'O') {
                            const shiftHrs = (typeof dayData.shiftHours === 'number') ? dayData.shiftHours : 0;
                            const vacationHrs = (typeof dayData.vacationHours === 'number') ? dayData.vacationHours : 0;
                            const totalHrs = shiftHrs + vacationHrs;
                            
                            const hoursDisplayParts = [];
                            if (shiftHrs > 0) hoursDisplayParts.push(`${shiftHrs}s`);
                            if (vacationHrs > 0) hoursDisplayParts.push(`${vacationHrs}v`);
                            
                            if (hoursDisplayParts.length > 0) {
                                displayText += ` (${hoursDisplayParts.join('+')}) = ${totalHrs}h paid`;
                            }
                        }
                        
                        shiftTypeTag.textContent = displayText;
                        shiftInfo.appendChild(shiftTypeTag);
                    }

                    if (dayData.unit && dayData.unit !== 'N/A') {
                        const unitTag = document.createElement('div');
                        unitTag.className = 'shift-tag';
                        if (['TGPACU', 'TWPACU'].includes(dayData.unit)) {
                            unitTag.classList.add('pacu');
                        } else if (dayData.unit === 'Floor') {
                            unitTag.classList.add('floor');
                        } else {
                            unitTag.classList.add('icu');
                        }
                        unitTag.textContent = dayData.unit;
                        shiftInfo.appendChild(unitTag);
                    }
                    if (dayData.assignment === 'Double') {
                        const assignmentTag = document.createElement('div');
                        assignmentTag.className = 'shift-tag';
                        assignmentTag.style.background = 'linear-gradient(135deg, #ed8936, #dd6b20)';
                        assignmentTag.textContent = 'Double';
                        shiftInfo.appendChild(assignmentTag);
                    }

                    if (dayData.isolation && dayData.isolation !== 'None' && dayData.isolation !== 'Not specified') {
                        const isolationTag = document.createElement('div');
                        isolationTag.className = 'shift-tag';
                        isolationTag.style.background = 'linear-gradient(135deg, #9f7aea, #805ad5)';
                        isolationTag.textContent = `${dayData.isolation} ISO`;
                        shiftInfo.appendChild(isolationTag);
                    }

                    if (dayData.treatments && dayData.treatments.length > 0) {
                        const treatmentTag = document.createElement('div');
                        treatmentTag.className = 'shift-tag';
                        treatmentTag.style.background = 'linear-gradient(135deg, #38b2ac, #319795)';
                        treatmentTag.textContent = dayData.treatments.join(', ');
                        shiftInfo.appendChild(treatmentTag);
                    }

                } else {
                    const addBtn = document.createElement('div');
                    addBtn.className = 'add-shift-btn';
                    addBtn.textContent = '+ Add Shift';
                    addBtn.onclick = (e) => {
                        e.stopPropagation();
                        openModal(date);
                    };
                    shiftInfo.appendChild(addBtn);
                }

                dayElement.appendChild(shiftInfo);
                calendar.appendChild(dayElement);
            }
        }

        window.openModal = function(date) {
            isEditing = false;
            selectedDay = date;
            selectedDateKey = getDateKey(date);

            document.getElementById('selectedDate').textContent = date.toLocaleDateString();
            document.getElementById('unit').value = '';
            document.getElementById('shiftType').value = '';
            document.getElementById('assignment').value = '';
            document.getElementById('isolation').value = '';
            document.getElementById('comments').value = '';
            document.getElementById('shiftHours').value = '';
            document.getElementById('vacationHours').value = '';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

            const primaryBtn = document.getElementById('primaryActionBtn');
            primaryBtn.replaceWith(primaryBtn.cloneNode(true));
            const freshBtn = document.getElementById('primaryActionBtn');
            document.getElementById('modalTitle').textContent = 'Add Shift';
            freshBtn.textContent = 'Add Shift';
            freshBtn.onclick = addShift;
            
            try { applyShiftTypeConstraints(); } catch(e) {}

            try { document.getElementById("shiftType").focus(); } catch(e) {}
            document.getElementById('shiftModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('shiftModal').classList.remove('active');
            selectedDay = null;
            selectedDateKey = null;
        };

        window.viewShift = function(date, shift, key) {
            selectedDay = date;
            selectedDateKey = key || getDateKey(date);
            currentShiftId = shift.id;

            document.getElementById('viewShiftDate').textContent = date.toLocaleDateString();

            let customHoursDisplay = '';
            if (shift.shiftType === 'O') {
                const hoursParts = [];
                const shiftHrs = (typeof shift.shiftHours === 'number') ? shift.shiftHours : 0;
                const vacationHrs = (typeof shift.vacationHours === 'number') ? shift.vacationHours : 0;
                
                if (shiftHrs > 0) hoursParts.push(`${shiftHrs} shift hours`);
                if (vacationHrs > 0) hoursParts.push(`${vacationHrs} vacation hours`);
                
                if (hoursParts.length > 0) {
                    const totalHours = shiftHrs + vacationHrs;
                    customHoursDisplay = `<br><strong>Custom Hours:</strong> ${hoursParts.join(', ')} = ${totalHours} total paid hours<br><strong>Vacation Bank Impact:</strong> -${vacationHrs} hours`;
                }
            }

            const details = document.getElementById('shiftDetails');
            details.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>Unit:</strong> ${shift.unit || "N/A"}<br>
                    <strong>Shift Type:</strong> ${shift.shiftType && shift.shiftType !== 'Not specified' ? getShiftTypeDisplay(shift.shiftType) : 'Not specified'}<br>
                    <strong>Assignment:</strong> ${shift.assignment && shift.assignment !== 'Not specified' ? shift.assignment : 'Not specified'}<br>
                    <strong>Isolation:</strong> ${shift.isolation && shift.isolation !== 'Not specified' ? (shift.isolation === 'None' ? 'No Isolation' : shift.isolation + ' Isolation(s)') : 'Not specified'}<br>
                    <strong>Special Treatments:</strong> ${shift.treatments && shift.treatments.length > 0 ? shift.treatments.join(', ') : 'None'}<br>
                    ${customHoursDisplay}
                    ${shift.comments ? `<strong>Comments:</strong><br>${shift.comments.replace(/\n/g, '<br>')}` : ''}
                </div>
            `;

            document.getElementById('viewShiftModal').classList.add('active');
        };

        window.closeViewModal = function(preserveState = false) {
            document.getElementById('viewShiftModal').classList.remove('active');
            if (!preserveState) {
                selectedDay = null;
                selectedDateKey = null;
                currentShiftId = null;
            }
        };

        window.editShift = function() {
            const shift = shiftData[selectedDateKey];
            if (!shift) return;

            isEditing = true;
            currentShiftId = shift.id || currentShiftId;

            const v = document.getElementById('viewShiftModal');
            if (v) v.classList.remove('active');

            document.getElementById('selectedDate').textContent = selectedDay.toLocaleDateString();
            document.getElementById('unit').value = shift.unit || '';
            document.getElementById('shiftType').value = shift.shiftType || '';
            document.getElementById('assignment').value = shift.assignment || '';
            document.getElementById('isolation').value = shift.isolation || '';
            document.getElementById('comments').value = shift.comments || '';
            document.getElementById('shiftHours').value = shift.shiftHours || '';
            document.getElementById('vacationHours').value = shift.vacationHours || '';

            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = Array.isArray(shift.treatments) && shift.treatments.includes(cb.value);
            });

            const primaryBtn = document.getElementById('primaryActionBtn');
            primaryBtn.replaceWith(primaryBtn.cloneNode(true));
            const freshBtn = document.getElementById('primaryActionBtn');
            document.getElementById('modalTitle').textContent = 'Edit Shift';
            freshBtn.textContent = 'Save Changes';
            freshBtn.onclick = updateShift;

            try { applyShiftTypeConstraints(); } catch(e) {}
            document.getElementById('shiftModal').classList.add('active');
        };

        // Notes system
        window.openNotesModal = function () {
            loadNotes();
            updateRVAndBankFigures();
            document.getElementById('notesModal').classList.add('active');
        };

        window.closeNotesModal = function () {
            document.getElementById('notesModal').classList.remove('active');
        };

        function loadNotes() {
            // 1) Fast local fill for instant UI
            try {
                const saved = JSON.parse(localStorage.getItem('nursing-notes') || '{}');
                notesData = { payNotes: "", otMentor: [], vacationBank: 0, ...saved };
                const payNotesEl = document.getElementById('payNotes');
                const bankEl = document.getElementById('vacationBank');
                if (payNotesEl) payNotesEl.value = notesData.payNotes || "";
                if (bankEl) bankEl.value = notesData.vacationBank || 0;
                renderOtMentorTable();
            } catch (e) {
                // ignore cache errors
            }

            // 2) Cloud reconciliation (authoritative copy)
            (async () => {
                if (!currentUser) return;
                try {
                    const snap = await get(getSecureRef('notes'));
                    if (snap.exists()) {
                        notesData = { payNotes: "", otMentor: [], vacationBank: 0, ...(snap.val() || {}) };
                        localStorage.setItem('nursing-notes', JSON.stringify(notesData));
                        const payNotesEl = document.getElementById('payNotes');
                        const bankEl = document.getElementById('vacationBank');
                        if (payNotesEl) payNotesEl.value = notesData.payNotes || "";
                        if (bankEl) bankEl.value = notesData.vacationBank || 0;
                        renderOtMentorTable();
                        try { updateRVAndBankFigures(); } catch(e){}
                    } else if ((notesData.payNotes || (notesData.otMentor||[]).length || notesData.vacationBank)) {
                        // First-time uplift: local -> cloud
                        await set(getSecureRef('notes'), notesData);
                    }
                } catch (e) {
                    console.warn('Notes cloud sync failed:', e.message);
                }
            })();
        }

        window.saveNotes = async function () {
            notesData.payNotes = (document.getElementById('payNotes')?.value || "");
            notesData.vacationBank = parseFloat(document.getElementById('vacationBank')?.value) || 0;
            try {
                // Cache for offline
                localStorage.setItem('nursing-notes', JSON.stringify(notesData));
                // Cloud for cross-device sync
                if (currentUser) await set(getSecureRef('notes'), notesData);
                try { updateRVAndBankFigures(); } catch(e){}
                closeNotesModal();
            } catch (e) {
                console.error('Error saving notes:', e);
                alert('Failed to save notes: ' + e.message);
            }
        };

        function renderOtMentorTable() {
            const tbody = document.querySelector("#otMentorTable tbody");
            if (!tbody) return;
            tbody.innerHTML = "";
            notesData.otMentor.forEach((e, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${e.date || ''}</td>
                    <td>${e.type || ''}</td>
                    <td>${(Number(e.hours) || 0).toFixed(2)}</td>
                    <td style="text-align:right;">
                        <button class="modal-btn danger" onclick="deleteOtMentorEntry(${idx})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.addOtMentorEntry = async function () {
            const date = prompt("Enter date (YYYY-MM-DD):") || "";
            const type = prompt("Enter type (OT/Mentor/Other(specify):") || "";
            const hours = parseFloat(prompt("Enter hours:")) || 0;
            notesData.otMentor.push({ date, type, hours });
            renderOtMentorTable();
            await saveNotes(); // writes local + cloud
        };

        window.deleteOtMentorEntry = async function (idx) {
            notesData.otMentor.splice(idx, 1);
            renderOtMentorTable();
            await saveNotes(); // writes local + cloud
        };

        function updateRVAndBankFigures() {
            const year = new Date().getFullYear();
            let rvCount = 0;
            let regularVacationCount = 0;
            let customVacationHours = 0;

            Object.keys(shiftData || {}).forEach(dateKey => {
                const s = shiftData[dateKey];
                if (!s) return;
                const y = parseInt(String(dateKey).split('-')[0], 10);
                if (y === year) {
                    if (s.shiftType === 'RV') {
                        rvCount++;
                    } else if (s.shiftType === 'V') {
                        regularVacationCount++;
                    } else if (s.shiftType === 'O' && typeof s.vacationHours === 'number') {
                        customVacationHours += s.vacationHours;
                    }
                }
            });

            const rvHours = rvCount * 11.25;
            const regularVacationHours = regularVacationCount * 7.5;
            const bank = Number(notesData.vacationBank || 0);
            const totalVacationUsed = rvHours + customVacationHours;
            const remaining = bank - totalVacationUsed;

            // Update all the display elements
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            updateElement('rvCount', String(rvCount));
            updateElement('rvHours', rvHours.toFixed(2));
            updateElement('regularVacationCount', String(regularVacationCount));
            updateElement('regularVacationHours', regularVacationHours.toFixed(2));
            updateElement('customVacationHours', customVacationHours.toFixed(2));
            updateElement('totalVacationUsed', totalVacationUsed.toFixed(2));
            updateElement('vacationRemaining', remaining.toFixed(2));
        }

        // Pay settings system
        window.openSettingsModal = function() {
            loadPaySettings();
            document.getElementById('settingsModal').classList.add('active');
        };

        window.closeSettingsModal = function() {
            document.getElementById('settingsModal').classList.remove('active');
        };

        function loadPaySettings() {
            // 1) Fast local fill
            try {
                const saved = JSON.parse(window.localStorage.getItem('nursing-pay-settings') || '{}');
                paySettings = saved || {};

                const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v ?? ''); };
                setVal('baseRate', saved.baseRate);
                setVal('eveningPremium', saved.eveningPremium);
                setVal('nightPremium', saved.nightPremium);
                setVal('weekendPremium', saved.weekendPremium);
                setVal('manualOvertimeHours', saved.manualOvertimeHours);
                setVal('overtimeMultiplier', saved.overtimeMultiplier ?? 1.5);
            } catch (error) {
                console.error('Error loading pay settings from localStorage:', error);
                paySettings = {};
            }

            // 2) Cloud reconciliation
            (async () => {
                if (!currentUser) return;
                try {
                    const snap = await get(getSecureRef('settings'));
                    if (snap.exists()) {
                        const cloud = snap.val() || {};
                        paySettings = cloud;
                        window.localStorage.setItem('nursing-pay-settings', JSON.stringify(cloud));
                        ['baseRate','eveningPremium','nightPremium','weekendPremium','manualOvertimeHours','overtimeMultiplier']
                            .forEach(id => { const el = document.getElementById(id); if (el) el.value = (cloud[id] ?? (id==='overtimeMultiplier'?1.5:'')); });
                    } else if (Object.keys(paySettings).length) {
                        // First-time uplift: local -> cloud
                        await set(getSecureRef('settings'), paySettings);
                    }
                } catch (e) {
                    console.warn('Settings cloud sync failed:', e.message);
                }
            })();
        }

        window.saveSettings = async function() {
            const settings = {
                baseRate: parseFloat(document.getElementById('baseRate')?.value) || 0,
                eveningPremium: parseFloat(document.getElementById('eveningPremium')?.value) || 0,
                nightPremium: parseFloat(document.getElementById('nightPremium')?.value) || 0,
                weekendPremium: parseFloat(document.getElementById('weekendPremium')?.value) || 0,
                manualOvertimeHours: parseFloat(document.getElementById('manualOvertimeHours')?.value) || 0,
                overtimeMultiplier: parseFloat(document.getElementById('overtimeMultiplier')?.value) || 1.5
            };

            if (settings.baseRate === 0) { alert('Please enter a base hourly rate'); return; }

            try {
                // Cache for offline
                window.localStorage.setItem('nursing-pay-settings', JSON.stringify(settings));
                paySettings = settings;
                // Cloud for cross-device sync
                if (currentUser) await set(getSecureRef('settings'), settings);
                closeSettingsModal();
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings: ' + error.message);
            }
        };

        function initializePaySettings() {
            loadPaySettings();
        }

        // Pay calculation system
        window.openPayPeriodModal = function() {
            loadPaySettings();
            setCurrentBiWeekly();
            document.getElementById('payPeriodModal').classList.add('active');
        };

        window.closePayPeriodModal = function() {
            document.getElementById('payPeriodModal').classList.remove('active');
        };

        window.setCurrentBiWeekly = function() {
            const today = new Date();
            const start = getPayPeriodStart(today);
            const end = new Date(start);
            end.setDate(start.getDate() + 13);
            
            document.getElementById('payPeriodStart').value = formatDateForInput(start);
            document.getElementById('payPeriodEnd').value = formatDateForInput(end);
        };

        window.setPreviousBiWeekly = function() {
            const current = document.getElementById('payPeriodStart').value ? parseLocalInputDate(document.getElementById('payPeriodStart').value) : new Date();
            current.setDate(current.getDate() - 14);
            const start = getPayPeriodStart(current);
            const end = new Date(start);
            end.setDate(start.getDate() + 13);
            
            document.getElementById('payPeriodStart').value = formatDateForInput(start);
            document.getElementById('payPeriodEnd').value = formatDateForInput(end);
        };

        window.setNextBiWeekly = function() {
            const current = document.getElementById('payPeriodEnd').value ? parseLocalInputDate(document.getElementById('payPeriodEnd').value) : new Date();
            current.setDate(current.getDate() + 1);
            const start = getPayPeriodStart(current);
            const end = new Date(start);
            end.setDate(start.getDate() + 13);
            
            document.getElementById('payPeriodStart').value = formatDateForInput(start);
            document.getElementById('payPeriodEnd').value = formatDateForInput(end);
        };

        function getPayPeriodStart(date) {
            const start = new Date(date);
            const dayOfWeek = start.getDay();
            start.setDate(start.getDate() - dayOfWeek);
            
            const reference = new Date(2024, 0, 7);
            const daysDiff = Math.floor((start - reference) / (1000 * 60 * 60 * 24));
            const periodsDiff = Math.floor(daysDiff / 14);
            
            reference.setDate(reference.getDate() + (periodsDiff * 14));
            return reference;
        }

        function formatDateForInput(date) { return formatDateForInputLocal(date); }

        window.calculatePay = function() {
            const startDate = document.getElementById('payPeriodStart').value;
            const endDate = document.getElementById('payPeriodEnd').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            if (Object.keys(paySettings).length === 0 || paySettings.baseRate === 0) {
                alert('Please configure your pay settings first');
                return;
            }

            currentPayPeriod = {
                start: parseLocalInputDate(startDate), end: parseLocalInputDate(endDate)
            };

            const payData = calculatePayForPeriod(currentPayPeriod.start, currentPayPeriod.end);
            displayPayResults(payData);
            
            closePayPeriodModal();
            document.getElementById('payResultsModal').classList.add('active');
        };

        function calculatePayForPeriod(startDate, endDate) {
            const payData = {
                period: { start: startDate, end: endDate },
                shifts: [],
                totals: {
                    totalHours: 0,
                    regularHours: 0,
                    overtimeHours: 0,
                    basePay: 0,
                    eveningPremium: 0,
                    nightPremium: 0,
                    weekendPremium: 0,
                    overtimePay: 0,
                    totalPay: 0
                }
            };

            Object.keys(shiftData).forEach(dateKey => {
                const shiftDate = parseLocalDateKey(dateKey);
                
                if (shiftDate >= startDate && shiftDate <= endDate) {
                    const shift = shiftData[dateKey];
                    if (shift) {
                        const shiftPay = calculateShiftPay(shiftDate, shift);
                        payData.shifts.push({
                            shiftDate: shiftDate,
                            ...shift,
                            ...shiftPay
                        });
                        
                        payData.totals.totalHours += shiftPay.hours;
                        payData.totals.basePay += shiftPay.basePay;
                        payData.totals.eveningPremium += shiftPay.eveningPremium;
                        payData.totals.nightPremium += shiftPay.nightPremium;
                        payData.totals.weekendPremium += shiftPay.weekendPremium;
                    }
                }
            });

            payData.totals.overtimeHours = paySettings.manualOvertimeHours;
            payData.totals.regularHours = payData.totals.totalHours;
            payData.totals.overtimePay = paySettings.manualOvertimeHours * paySettings.baseRate * (paySettings.overtimeMultiplier - 1);

            payData.totals.totalPay = payData.totals.basePay + 
                                     payData.totals.eveningPremium + 
                                     payData.totals.nightPremium + 
                                     payData.totals.weekendPremium + 
                                     payData.totals.overtimePay;

            return payData;
        }

        function calculateShiftPay(date, shift) {
            let hours = getShiftHours(shift); // Use the new function to get actual hours
            const dayOfWeek = date.getDay();
            
            let basePay = hours * paySettings.baseRate;
            let eveningPremium = 0;
            let nightPremium = 0;
            let weekendPremium = 0;
            let premiums = [];

            // Only calculate premiums for standard shift types, not for custom "Other" shifts
            if (shift.shiftType === 'D') {
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    eveningPremium = 3.75 * paySettings.eveningPremium;
                    premiums.push('Evening');
                } else if (dayOfWeek === 0 || dayOfWeek === 6) {
                    weekendPremium = 11.25 * paySettings.weekendPremium;
                    eveningPremium = 3.75 * paySettings.eveningPremium
                    premiums.push('Weekend','Evening');
                }
            } else if (shift.shiftType === 'N') {
                if (dayOfWeek >= 1 && dayOfWeek <= 4) {
                    eveningPremium = 3.75 * paySettings.eveningPremium;
                    nightPremium = 7.5 * paySettings.nightPremium;
                    premiums.push('Evening', 'Night');
                } else if (dayOfWeek === 5) {
                    weekendPremium = 7 * paySettings.weekendPremium;
                    eveningPremium = 3.75 * paySettings.eveningPremium;
                    nightPremium = 7.5 * paySettings.nightPremium;
                    premiums.push('Weekend','Evening', 'Night');
                } else if (dayOfWeek === 6) {
                    weekendPremium = 11.25 * paySettings.weekendPremium;
                    eveningPremium = 3.75 * paySettings.eveningPremium;
                    nightPremium = 7.5 * paySettings.nightPremium;
                    premiums.push('Weekend','Evening', 'Night');
                } else if (dayOfWeek === 0) {
                    weekendPremium = 4.25 * paySettings.weekendPremium;
                    eveningPremium = 3.75 * paySettings.eveningPremium;
                    nightPremium = 7.5 * paySettings.nightPremium;
                    premiums.push('Weekend','Evening', 'Night');
                }
            }
            // Note: For "Other" shifts with custom hours, no premiums are calculated

            return {
                hours,
                basePay,
                eveningPremium,
                nightPremium,
                weekendPremium,
                premiums,
                totalPay: basePay + eveningPremium + nightPremium + weekendPremium
            };
        }

        function displayPayResults(payData) {
            const periodText = `${payData.period.start.toLocaleDateString()} - ${payData.period.end.toLocaleDateString()}`;
            document.getElementById('payResultsPeriod').textContent = periodText;

            let html = `
                <div class="pay-summary">
                    <div class="pay-summary-grid">
                        <div class="pay-summary-item">
                            <div class="pay-summary-value">${payData.totals.totalPay.toFixed(2)}</div>
                            <div class="pay-summary-label">Total Pay</div>
                        </div>
                        <div class="pay-summary-item">
                            <div class="pay-summary-value">${payData.totals.totalHours.toFixed(2)}</div>
                            <div class="pay-summary-label">Total Hours</div>
                        </div>
                        <div class="pay-summary-item">
                            <div class="pay-summary-value">${payData.shifts.length}</div>
                            <div class="pay-summary-label">Total Shifts</div>
                        </div>
                        ${payData.totals.overtimeHours > 0 ? `
                        <div class="pay-summary-item">
                            <div class="pay-summary-value">${payData.totals.overtimeHours.toFixed(2)}</div>
                            <div class="pay-summary-label">Overtime Hours</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <h4>Shift-by-Shift Breakdown:</h4>
                <table class="pay-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Unit</th>
                            <th>Type</th>
                            <th>Hours</th>
                            <th>Base Pay</th>
                            <th>Premiums</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            payData.shifts.forEach(shift => {
                const premiumDetails = [];
                if (shift.eveningPremium > 0) premiumDetails.push(`Evening: ${shift.eveningPremium.toFixed(2)}`);
                if (shift.nightPremium > 0) premiumDetails.push(`Night: ${shift.nightPremium.toFixed(2)}`);
                if (shift.weekendPremium > 0) premiumDetails.push(`Weekend: ${shift.weekendPremium.toFixed(2)}`);

                let typeDisplay = getShiftTypeDisplay(shift.shiftType);
                if (shift.shiftType === 'O') {
                    const customHoursParts = [];
                    if (typeof shift.shiftHours === 'number') {
                        customHoursParts.push(`${shift.shiftHours}h`);
                    }
                    if (typeof shift.vacationHours === 'number') {
                        customHoursParts.push(`${shift.vacationHours}v`);
                    }
                    if (customHoursParts.length > 0) {
                        typeDisplay += ` (${customHoursParts.join(', ')})`;
                    }
                }

                html += `
                    <tr>
                        <td>${shift.shiftDate.toLocaleDateString()}</td>
                        <td>${shift.unit}</td>
                        <td>
                            ${typeDisplay}
                            ${shift.premiums.map(p => `<span class="premium-tag ${p.toLowerCase()}">${p}</span>`).join('')}
                        </td>
                        <td>${shift.hours.toFixed(2)}</td>
                        <td class="currency">${shift.basePay.toFixed(2)}</td>
                        <td class="currency">
                            ${premiumDetails.length > 0 ? premiumDetails.join('<br>') : '-'}
                        </td>
                        <td class="currency">${shift.totalPay.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <h4>Pay Summary:</h4>
                <table class="pay-table">
                    <tbody>
                        <tr>
                            <td><strong>Regular Hours (${payData.totals.regularHours.toFixed(2)})</strong></td>
                            <td class="currency"><strong>${payData.totals.basePay.toFixed(2)}</strong></td>
                        </tr>
                        ${payData.totals.eveningPremium > 0 ? `
                        <tr>
                            <td>Evening Premium</td>
                            <td class="currency">${payData.totals.eveningPremium.toFixed(2)}</td>
                        </tr>
                        ` : ''}
                        ${payData.totals.nightPremium > 0 ? `
                        <tr>
                            <td>Night Premium</td>
                            <td class="currency">${payData.totals.nightPremium.toFixed(2)}</td>
                        </tr>
                        ` : ''}
                        ${payData.totals.weekendPremium > 0 ? `
                        <tr>
                            <td>Weekend Premium</td>
                            <td class="currency">${payData.totals.weekendPremium.toFixed(2)}</td>
                        </tr>
                        ` : ''}
                        ${payData.totals.overtimeHours > 0 ? `
                        <tr>
                            <td>Overtime (manual: ${payData.totals.overtimeHours.toFixed(2)}h at ${paySettings.overtimeMultiplier}x)</td>
                            <td class="currency">${payData.totals.overtimePay.toFixed(2)}</td>
                        </tr>
                        ` : ''}
                        <tr class="total-row">
                            <td><strong>TOTAL PAY</strong></td>
                            <td class="currency"><strong>${payData.totals.totalPay.toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                </table>
            `;

            document.getElementById('payResultsContent').innerHTML = html;
        }

        window.closePayResultsModal = function() {
            document.getElementById('payResultsModal').classList.remove('active');
        };

        window.exportPayCSV = function() {
            if (!currentPayPeriod.start || !currentPayPeriod.end) {
                alert('No pay calculation to export');
                return;
            }

            const payData = calculatePayForPeriod(currentPayPeriod.start, currentPayPeriod.end);
            const csvData = [];
            
            csvData.push(['PAY CALCULATION REPORT']);
            csvData.push(['Period', `${payData.period.start.toLocaleDateString()} - ${payData.period.end.toLocaleDateString()}`]);
            csvData.push(['']);
            
            csvData.push(['PAY SETTINGS USED']);
            csvData.push(['Base Rate', `${paySettings.baseRate.toFixed(2)}`]);
            csvData.push(['Evening Premium', `${paySettings.eveningPremium.toFixed(2)}`]);
            csvData.push(['Night Premium', `${paySettings.nightPremium.toFixed(2)}`]);
            csvData.push(['Weekend Premium', `${paySettings.weekendPremium.toFixed(2)}`]);
            csvData.push(['Manual Overtime Hours', `${Number(paySettings.manualOvertimeHours || 0).toFixed(2)} hours`]);
            csvData.push(['Overtime Multiplier', `${paySettings.overtimeMultiplier}x`]);
            csvData.push(['']);

            csvData.push(['SHIFT BREAKDOWN']);
            csvData.push(['Date', 'Unit', 'Shift Type', 'Hours', 'Base Pay', 'Evening Premium', 'Night Premium', 'Weekend Premium', 'Shift Total', 'Custom Hours']);
            
            payData.shifts.forEach(shift => {
                let customHoursInfo = '';
                if (shift.shiftType === 'O') {
                    const parts = [];
                    if (typeof shift.shiftHours === 'number') parts.push(`${shift.shiftHours} shift`);
                    if (typeof shift.vacationHours === 'number') parts.push(`${shift.vacationHours} vacation`);
                    if (parts.length > 0) customHoursInfo = parts.join(', ');
                }
                
                csvData.push([
                    shift.shiftDate.toLocaleDateString(),
                    shift.unit,
                    getShiftTypeDisplay(shift.shiftType),
                    shift.hours.toFixed(2),
                    `${shift.basePay.toFixed(2)}`,
                    `${shift.eveningPremium.toFixed(2)}`,
                    `${shift.nightPremium.toFixed(2)}`,
                    `${shift.weekendPremium.toFixed(2)}`,
                    `${shift.totalPay.toFixed(2)}`,
                    customHoursInfo
                ]);
            });

            csvData.push(['']);
            csvData.push(['SUMMARY']);
            csvData.push(['Total Hours', payData.totals.totalHours.toFixed(2)]);
            csvData.push(['Regular Hours', payData.totals.regularHours.toFixed(2)]);
            csvData.push(['Overtime Hours', payData.totals.overtimeHours.toFixed(2)]);
            csvData.push(['Base Pay', `${payData.totals.basePay.toFixed(2)}`]);
            csvData.push(['Evening Premium Total', `${payData.totals.eveningPremium.toFixed(2)}`]);
            csvData.push(['Night Premium Total', `${payData.totals.nightPremium.toFixed(2)}`]);
            csvData.push(['Weekend Premium Total', `${payData.totals.weekendPremium.toFixed(2)}`]);
            csvData.push(['Overtime Pay', `${payData.totals.overtimePay.toFixed(2)}`]);
            csvData.push(['TOTAL PAY', `${payData.totals.totalPay.toFixed(2)}`]);

            const csvContent = csvData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pay-calculation-${currentPayPeriod.start.toISOString().split('T')[0]}-to-${currentPayPeriod.end.toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        function updateStats() {
            let _rvRemainingForStats = (() => {
                try {
                    const year = new Date().getFullYear();
                    let rvCount = 0;
                    let customVacationHours = 0;
                    let regularVacationHours = 0;
                    Object.keys(shiftData || {}).forEach(k => {
                        const s = shiftData[k];
                        if (!s) return;
                        const y = parseInt(String(k).split('-')[0], 10);
                        if (y === year) {
                            if (s.shiftType === 'RV') {
                                rvCount++;
                            } else if (s.shiftType === 'O' && typeof s.vacationHours === 'number') {
                                customVacationHours += s.vacationHours;
                            } else if (s.shiftType === 'V') {
                                regularVacationHours += 7.5;
                            }
                        }
                    });
                    const notes = JSON.parse(localStorage.getItem('nursing-notes') || '{}');
                    const bank = Number(notes && notes.vacationBank ? notes.vacationBank : 0);
                    const totalUsed = (rvCount * 11.25) + customVacationHours;
                    return bank - totalUsed;
                } catch(e) { return 0; }
            })();

            const statsGrid = document.getElementById('statsGrid');
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = currentYear;
            
            statsGrid.innerHTML = '';

            let totalShifts = 0;
            let dayShifts = 0;
            let nightShifts = 0;
            let otherShifts = 0;
            let sickCalls = 0;
            let vacations = 0;
            let requestedVacations = 0;
            let doubleAssignments = 0;
            let singleAssignments = 0;
            let noIsolation = 0;
            let oneIsolation = 0;
            let twoIsolations = 0;
            let pacuShifts = 0;
            let floorShifts = 0;
            let totalHours = 0;
            let customShiftHours = 0;
            let customVacationHours = 0;

            Object.keys(shiftData).forEach(dateKey => {
                const [year] = dateKey.split('-').map(Number);
                if (year === currentYear) {
                    const shift = shiftData[dateKey];
                    if (shift) {
                        totalShifts++;
                        
                        // Calculate hours using the new getShiftHours function
                        totalHours += getShiftHours(shift);
                        
                        if (shift.shiftType === 'D') {
                            dayShifts++;
                        } else if (shift.shiftType === 'N') {
                            nightShifts++;
                        } else if (shift.shiftType === 'O') {
                            otherShifts++;
                            if (typeof shift.shiftHours === 'number') {
                                customShiftHours += shift.shiftHours;
                            }
                            if (typeof shift.vacationHours === 'number') {
                                customVacationHours += shift.vacationHours;
                            }
                        } else if (shift.shiftType === 'S') {
                            sickCalls++;
                        } else if (shift.shiftType === 'V') {
                            vacations++;
                        } else if (shift.shiftType === 'RV') {
                            requestedVacations++;
                        }
                        
                        if (shift.assignment === 'Double') {
                            doubleAssignments++;
                        } else if (shift.assignment === 'Single') {
                            singleAssignments++;
                        }
                        
                        if (shift.isolation === 'None') {
                            noIsolation++;
                        } else if (shift.isolation === '1') {
                            oneIsolation++;
                        } else if (shift.isolation === '2') {
                            twoIsolations++;
                        }
                        
                        if (['TGPACU', 'TWPACU'].includes(shift.unit)) {
                            pacuShifts++;
                        }
                        
                        if (shift.unit === 'Floor') {
                            floorShifts++;
                        }
                    }
                }
            });

const workShifts = dayShifts + nightShifts; // Only count actual working shifts for percentages
const doubleAssignmentPercent = workShifts > 0 ? Math.round((doubleAssignments / workShifts) * 100) : 0;
const singleAssignmentPercent = workShifts > 0 ? Math.round((singleAssignments / workShifts) * 100) : 0;
const noIsolationPercent = workShifts > 0 ? Math.round((noIsolation / workShifts) * 100) : 0;
const oneIsolationPercent = workShifts > 0 ? Math.round((oneIsolation / workShifts) * 100) : 0;
const twoIsolationPercent = workShifts > 0 ? Math.round((twoIsolations / workShifts) * 100) : 0;
const pacuPercent = workShifts > 0 ? Math.round((pacuShifts / workShifts) * 100) : 0;
const floorPercent = workShifts > 0 ? Math.round((floorShifts / workShifts) * 100) : 0;

            const stats = [
                { label: 'Total Shifts', value: totalShifts },
                { label: 'Total Hours', value: totalHours.toFixed(2) },
                { label: 'Day Shifts', value: dayShifts },
                { label: 'Night Shifts', value: nightShifts },
                { label: 'Other Shifts', value: otherShifts },
                { label: 'Sick Calls', value: sickCalls },
                { label: 'Vacations', value: `${vacations} (${(vacations * 7.5).toFixed(1)}h)` },
                { label: 'Requested Vacations', value: `${requestedVacations} (${(requestedVacations * 11.25).toFixed(1)}h)` },
                { label: 'Custom Other Hours', value: `${customShiftHours.toFixed(1)}h shift, ${customVacationHours.toFixed(1)}h vacation` },
                { label: 'Remaining Vacation Hours', value: (typeof _rvRemainingForStats !== 'undefined' ? _rvRemainingForStats.toFixed(2) : '0.00') },
                { label: 'Double Assignments', value: `${doubleAssignments} (${doubleAssignmentPercent}%)` },
                { label: 'Single Assignments', value: `${singleAssignments} (${singleAssignmentPercent}%)` },
                { label: 'No Isolation', value: `${noIsolation} (${noIsolationPercent}%)` },
                { label: '1 Isolation', value: `${oneIsolation} (${oneIsolationPercent}%)` },
                { label: '2 Isolations', value: `${twoIsolations} (${twoIsolationPercent}%)` },
                { label: 'PACU Shifts', value: `${pacuShifts} (${pacuPercent}%)` },
                { label: 'Floor Shifts', value: `${floorShifts} (${floorPercent}%)` }
            ];

            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-number">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsGrid.appendChild(card);
            });
        }

        window.exportToCSV = function() {
            const currentYear = new Date().getFullYear();
            const csvData = [];
            
            csvData.push(['SHIFT DATA']);
            csvData.push(['Date', 'Unit', 'Shift Type', 'Assignment', 'Isolation', 'Special Treatments', 'Comments', 'Hours', 'Custom Shift Hours', 'Custom Vacation Hours']);

            Object.keys(shiftData).forEach(dateKey => {
                const shift = shiftData[dateKey];
                const date = parseLocalDateKey(dateKey).toLocaleDateString();
                
                const hours = getShiftHours(shift);
                const customShiftHours = (shift.shiftType === 'O' && typeof shift.shiftHours === 'number') ? shift.shiftHours : '';
                const customVacationHours = (shift.shiftType === 'O' && typeof shift.vacationHours === 'number') ? shift.vacationHours : '';
                
                csvData.push([
                    date,
                    shift.unit,
                    shift.shiftType && shift.shiftType !== 'Not specified' ? getShiftTypeDisplay(shift.shiftType) : 'Not specified',
                    shift.assignment,
                    shift.isolation === 'None' ? 'No Isolation' : shift.isolation + ' Isolation(s)',
                    shift.treatments && shift.treatments.length > 0 ? shift.treatments.join(', ') : 'None',
                    shift.comments ? shift.comments.replace(/\n/g, ' | ') : '',
                    hours,
                    customShiftHours,
                    customVacationHours
                ]);
            });

            // Update statistics calculation to include the new fields
            let totalShifts = 0;
            let dayShifts = 0;
            let nightShifts = 0;
            let otherShifts = 0;
            let sickCalls = 0;
            let vacations = 0;
            let requestedVacations = 0;
            let doubleAssignments = 0;
            let singleAssignments = 0;
            let noIsolation = 0;
            let oneIsolation = 0;
            let twoIsolations = 0;
            let pacuShifts = 0;
            let floorShifts = 0;
            let totalHours = 0;
            let customShiftHours = 0;
            let customVacationHours = 0;

            Object.keys(shiftData).forEach(dateKey => {
                const [year] = dateKey.split('-').map(Number);
                if (year === currentYear) {
                    const shift = shiftData[dateKey];
                    if (shift) {
                        totalShifts++;
                        
                        totalHours += getShiftHours(shift);
                        
                        if (shift.shiftType === 'D') {
                            dayShifts++;
                        } else if (shift.shiftType === 'N') {
                            nightShifts++;
                        } else if (shift.shiftType === 'O') {
                            otherShifts++;
                            if (typeof shift.shiftHours === 'number') {
                                customShiftHours += shift.shiftHours;
                            }
                            if (typeof shift.vacationHours === 'number') {
                                customVacationHours += shift.vacationHours;
                            }
                        } else if (shift.shiftType === 'S') {
                            sickCalls++;
                        } else if (shift.shiftType === 'V') {
                            vacations++;
                        } else if (shift.shiftType === 'RV') {
                            requestedVacations++;
                        }
                        
                        if (shift.assignment === 'Double') {
                            doubleAssignments++;
                        } else if (shift.assignment === 'Single') {
                            singleAssignments++;
                        }
                        
                        if (shift.isolation === 'None') {
                            noIsolation++;
                        } else if (shift.isolation === '1') {
                            oneIsolation++;
                        } else if (shift.isolation === '2') {
                            twoIsolations++;
                        }
                        
                        if (['TGPACU', 'TWPACU'].includes(shift.unit)) {
                            pacuShifts++;
                        }
                        
                        if (shift.unit === 'Floor') {
                            floorShifts++;
                        }
                    }
                }
            });

	    const workShifts = dayShifts + nightShifts; // Only count actual working shifts for percentages
	    const doubleAssignmentPercent = workShifts > 0 ? Math.round((doubleAssignments / workShifts) * 100) : 0;
            const singleAssignmentPercent = workShifts > 0 ? Math.round((singleAssignments / workShifts) * 100) : 0;
            const noIsolationPercent = workShifts > 0 ? Math.round((noIsolation / workShifts) * 100) : 0;
            const oneIsolationPercent = workShifts > 0 ? Math.round((oneIsolation / workShifts) * 100) : 0;
            const twoIsolationPercent = workShifts > 0 ? Math.round((twoIsolations / workShifts) * 100) : 0;
            const pacuPercent = workShifts > 0 ? Math.round((pacuShifts / workShifts) * 100) : 0;
            const floorPercent = workShifts > 0 ? Math.round((floorShifts / workShifts) * 100) : 0;

            csvData.push(['']);
            csvData.push(['']);
            csvData.push([`ANNUAL STATISTICS (${currentYear})`]);
            csvData.push(['Category', 'Count', 'Hours/Percentage']);
            csvData.push(['Total Shifts', totalShifts, '']);
            csvData.push(['Total Hours', totalHours.toFixed(2), '']);
            csvData.push(['Day Shifts', dayShifts, '']);
            csvData.push(['Night Shifts', nightShifts, '']);
            csvData.push(['Other Shifts', otherShifts, '']);
            csvData.push(['Sick Calls', sickCalls, '']);
            csvData.push(['Vacations', vacations, (vacations * 7.5).toFixed(1) + ' hours']);
            csvData.push(['Requested Vacations', requestedVacations, (requestedVacations * 11.25).toFixed(1) + ' hours']);
            csvData.push(['Custom Other Shift Hours', '', customShiftHours.toFixed(1) + ' hours']);
            csvData.push(['Custom Other Vacation Hours', '', customVacationHours.toFixed(1) + ' hours']);
            csvData.push(['Double Assignments', doubleAssignments, doubleAssignmentPercent + '%']);
            csvData.push(['Single Assignments', singleAssignments, singleAssignmentPercent + '%']);
            csvData.push(['No Isolation', noIsolation, noIsolationPercent + '%']);
            csvData.push(['1 Isolation', oneIsolation, oneIsolationPercent + '%']);
            csvData.push(['2 Isolations', twoIsolations, twoIsolationPercent + '%']);
            csvData.push(['PACU Shifts', pacuShifts, pacuPercent + '%']);
            csvData.push(['Floor Shifts', floorShifts, floorPercent + '%']);

            const csvContent = csvData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nursing-shifts-with-stats-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        window.exportToJSON = function() {
            const currentYear = new Date().getFullYear();
            
            let totalShifts = 0;
            let dayShifts = 0;
            let nightShifts = 0;
            let otherShifts = 0;
            let sickCalls = 0;
            let vacations = 0;
            let requestedVacations = 0;
            let doubleAssignments = 0;
            let singleAssignments = 0;
            let noIsolation = 0;
            let oneIsolation = 0;
            let twoIsolations = 0;
            let pacuShifts = 0;
            let floorShifts = 0;
            let totalHours = 0;
            let customShiftHours = 0;
            let customVacationHours = 0;

            Object.keys(shiftData).forEach(dateKey => {
                const [year] = dateKey.split('-').map(Number);
                if (year === currentYear) {
                    const shift = shiftData[dateKey];
                    if (shift) {
                        totalShifts++;
                        
                        totalHours += getShiftHours(shift);
                        
                        if (shift.shiftType === 'D') {
                            dayShifts++;
                        } else if (shift.shiftType === 'N') {
                            nightShifts++;
                        } else if (shift.shiftType === 'O') {
                            otherShifts++;
                            if (typeof shift.shiftHours === 'number') {
                                customShiftHours += shift.shiftHours;
                            }
                            if (typeof shift.vacationHours === 'number') {
                                customVacationHours += shift.vacationHours;
                            }
                        } else if (shift.shiftType === 'S') {
                            sickCalls++;
                        } else if (shift.shiftType === 'V') {
                            vacations++;
                        } else if (shift.shiftType === 'RV') {
                            requestedVacations++;
                        }
                        
                        if (shift.assignment === 'Double') {
                            doubleAssignments++;
                        } else if (shift.assignment === 'Single') {
                            singleAssignments++;
                        }
                        
                        if (shift.isolation === 'None') {
                            noIsolation++;
                        } else if (shift.isolation === '1') {
                            oneIsolation++;
                        } else if (shift.isolation === '2') {
                            twoIsolations++;
                        }
                        
                        if (['TGPACU', 'TWPACU'].includes(shift.unit)) {
                            pacuShifts++;
                        }
                        
                        if (shift.unit === 'Floor') {
                            floorShifts++;
                        }
                    }
                }
            });

            const doubleAssignmentPercent = totalShifts > 0 ? Math.round((doubleAssignments / totalShifts) * 100) : 0;
            const singleAssignmentPercent = totalShifts > 0 ? Math.round((singleAssignments / totalShifts) * 100) : 0;
            const noIsolationPercent = totalShifts > 0 ? Math.round((noIsolation / totalShifts) * 100) : 0;
            const oneIsolationPercent = totalShifts > 0 ? Math.round((oneIsolation / totalShifts) * 100) : 0;
            const twoIsolationPercent = totalShifts > 0 ? Math.round((twoIsolations / totalShifts) * 100) : 0;
            const pacuPercent = totalShifts > 0 ? Math.round((pacuShifts / totalShifts) * 100) : 0;
            const floorPercent = totalShifts > 0 ? Math.round((floorShifts / totalShifts) * 100) : 0;

            const exportData = {
                exportDate: new Date().toISOString(),
                year: currentYear,
                statistics: {
                    totalShifts: totalShifts,
                    totalHours: totalHours,
                    shiftTypes: {
                        day: dayShifts,
                        night: nightShifts,
                        other: otherShifts,
                        sickCalls: sickCalls,
                        vacations: { count: vacations, hours: vacations * 7.5 },
                        requestedVacations: { count: requestedVacations, hours: requestedVacations * 11.25 }
                    },
                    customOtherHours: {
                        shiftHours: customShiftHours,
                        vacationHours: customVacationHours
                    },
                    assignments: {
                        double: { count: doubleAssignments, percentage: doubleAssignmentPercent },
                        single: { count: singleAssignments, percentage: singleAssignmentPercent }
                    },
                    isolation: {
                        none: { count: noIsolation, percentage: noIsolationPercent },
                        one: { count: oneIsolation, percentage: oneIsolationPercent },
                        two: { count: twoIsolations, percentage: twoIsolationPercent }
                    },
                    units: {
                        pacu: { count: pacuShifts, percentage: pacuPercent },
                        floor: { count: floorShifts, percentage: floorPercent }
                    }
                },
                shiftData: shiftData
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nursing-shifts-with-stats-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const st = document.getElementById('shiftType');
            if (st) st.addEventListener('change', window.applyShiftTypeConstraints);
        });

        document.getElementById('shiftModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('viewShiftModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeViewModal();
            }
        });

        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });

        document.getElementById('payPeriodModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePayPeriodModal();
            }
        });

        document.getElementById('payResultsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePayResultsModal();
            }
        });

        document.getElementById('notesModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNotesModal();
            }
        });

        // Auto-calculate end date when start date changes
        document.getElementById('payPeriodStart').addEventListener('change', function(e) {
            if (e.target.value) {
                const startDate = parseLocalInputDate(e.target.value);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 13);
                document.getElementById('payPeriodEnd').value = formatDateForInput(endDate);
            }
        });

        // Login button event
        document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);

    </script>
</body>
</html>